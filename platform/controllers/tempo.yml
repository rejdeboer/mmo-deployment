apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: tempo
  namespace: monitoring
spec:
  interval: 5m
  dependsOn:
    - name: kube-prometheus-stack
  chart:
    spec:
      version: "1.24"
      chart: tempo
      sourceRef:
        kind: HelmRepository
        name: grafana-charts
      interval: 60m
  values:
    extraEnv:
      - name: TEMPO_S3_ACCESS_KEY
        valueFrom:
          secretKeyRef:
            name: tempo-s3
            key: access-key
      - name: TEMPO_S3_SECRET_KEY
        valueFrom:
          secretKeyRef:
            name: tempo-s3
            key: secret-key
      - name: TEMPO_S3_BUCKET
        valueFrom:
          secretKeyRef:
            name: tempo-s3
            key: bucket
      - name: TEMPO_S3_ENDPOINT
        valueFrom:
          secretKeyRef:
            name: tempo-s3
            key: endpoint

    storage:
      trace:
        backend: s3
        s3:
          bucket: ${TEMPO_S3_BUCKET}
          endpoint: ${TEMPO_S3_ENDPOINT}
          access_key: ${TEMPO_S3_ACCESS_KEY}
          secret_key: ${TEMPO_S3_SECRET_KEY}
          insecure: true # True because internal k8s DNS (http) is not HTTPS
          s3ForcePathstyle: true # Required for MinIO

    tempo:
      receivers:
        otlp:
          protocols:
            grpc:
              endpoint: 0.0.0.0:4317
            http:
              endpoint: 0.0.0.0:4318

    persistence:
      enabled: true
      size: 10Gi
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: tempo-ingress
  namespace: monitoring
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: tempo
  policyTypes:
    - Ingress
  ingress:
    - from:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: grafana
      ports:
        - protocol: TCP
          port: 3200
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: default
      ports:
        - protocol: TCP
          port: 4317
        - protocol: TCP
          port: 4318

