apiVersion: batch/v1
kind: Job
metadata:
  name: db-migration
  namespace: default
spec:
  template:
    spec:
      restartPolicy: Never
      containers:
      - name: migration
        image: rejdeboer/mmo-db-migration:latest
        env:
          - name: DB_HOST
            value: postgres-main-rw.cnpg.svc.cluster.local
          - name: DB_PORT
            value: "5432"
          - name: DB_NAME
            value: mmo
          - name: DB_USERNAME
            value: mmo
          - name: DB_USERNAME
            valueFrom:
              secretKeyRef:
                name: pg-secret
                namespace: default
                key: username
          - name: DB_PASSWORD
            valueFrom:
              secretKeyRef:
                name: pg-secret
                namespace: default
                key: password
        command: ["/bin/sh", "-c"]
        args:
          - |
            export DATABASE_URL="postgresql://${DB_USER}:${DB_PASSWORD}@${DB_HOST}/${DB_NAME}?sslmode=disable"
            sqlx migrate run
